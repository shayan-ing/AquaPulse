const translations = {
    en: {
      appTitle: "AquaPulse",
      communityImpact: "Community Impact",
      savedThisMonth: "Saved This Month!",
      leakLocations: "Leak Locations",
      quickActions: "Quick Actions",
      reportLeak: "Report Leak",
      verifyLeaks: "Verify Leaks",
      viewLeaderboard: "Leaderboard",
      viewRiskMap: "Risk Mapping",
      conservationTip: "Weekly Conservation Tip",
      tipContent: "Fix dripping faucets to save up to 15L per day!",
      reportLeakTitle: "Report a Leak",
      describeLeak: "Describe the leak",
      addPhoto: "Add Photo",
      addVideo: "Add Video",
      voiceInput: "Voice Input",
      location: "Location",
      anonymousReport: "Report Anonymously",
      submitReport: "Submit Report",
      severity: "Severity: Minor",
      offlineWarning: "Report will sync when online.",
      verifyLeakTitle: "Verify a Leak",
      reported: "Reported",
      description: "Description",
      distance: "Distance",
      status: "Status",
      photoPreview: "Photo Preview",
      verificationProgress: "Verification Progress",
      confirmLeak: "Confirm Leak",
      markFalse: "Mark as False",
      comments: "Additional comments",
      officialVerified: "Official Verified",
      leaderboardTitle: "Leaderboard & Rewards",
      topReporters: "Top Reporters",
      badges: "Badges",
      aquaHero: "Aqua Hero",
      firstReport: "First Report",
      treeSapling: "Tree Sapling",
      waterKit: "Water Kit",
      redeemNow: "Redeem Now",
      shareAchievement: "Share Achievement",
      riskMapTitle: "Risk Mapping",
      statsOverview: "Statistics Overview",
      highRiskZones: "High-Risk Zones",
      nextLikely: "Next Likely (Location)",
      recentAlerts: "Recent Alerts",
      additionalFilters: "Additional Filters",
      verified: "Verified",
      unverified: "Unverified",
      downloadReport: "Download Report",
      profileTitle: "User Profile",
      yourImpact: "Your Impact",
      waterSaved: "Water Saved",
      pointsEarned: "Points Earned",
      editProfile: "Edit Profile",
      aboutMe: "About Me",
      preferencesStats: "Preferences & Stats",
      preferredLanguage: "Preferred Language",
      favoriteTip: "Favorite Tip",
      logout: "Logout",
      home: "Home",
      reports: "Reports",
      contact: "Contact",
      contactSupport: "Contact Support",
      followUs: "Follow Us",
      sendMessage: "Send Us a Message",
      yourName: "Your Name",
      yourEmail: "Your Email",
      yourMessage: "Your Message",
      submit: "Submit",
      settings: "Settings",
      accountSettings: "Account Settings",
      emailNotifications: "Email Notifications",
      pushNotifications: "Push Notifications",
      appPreferences: "App Preferences",
      language: "Language",
      theme: "Theme",
      dataUsage: "Data Usage",
      lowBandwidthMode: "Low Bandwidth Mode",
      save: "Save",
      back: "Back",
      locationAccessDenied: "Location access denied.",
      voiceInputError: "Voice input failed.",
      voiceInputNotSupported: "Voice input not supported in this browser.",
      imageUploaded: "Image uploaded successfully!",
      imageCompressionError: "Failed to compress image.",
      reportSubmitted: "Report submitted!",
      leakConfirmed: "Leak confirmed!",
      leakMarkedFalse: "Leak marked as false!",
      nearbyLeak: "Nearby Leak Detected!",
      leakNearbyBody: "A leak was reported 100m away at Lat: {lat}, Lon: {lng}. Verify now!",
      messageSent: "Message sent successfully!",
      settingsSaved: "Settings saved successfully!",
      profileSaved: "Profile updated successfully!"
    },
    hi: {
      appTitle: "एक्वापल्स",
      communityImpact: "समुदाय प्रभाव",
      savedThisMonth: "इस महीने बचाया गया!",
      leakLocations: "रिसाव स्थान",
      quickActions: "त्वरित कार्रवाई",
      reportLeak: "रिसाव की रिपोर्ट करें",
      verifyLeaks: "नजदीकी रिसाव सत्यापित करें",
      viewLeaderboard: "लीडरबोर्ड देखें",
      viewRiskMap: "जोखिम नक्शा",
      conservationTip: "साप्ताहिक संरक्षण सुझाव",
      tipContent: "टपकते नल को ठीक करें, प्रतिदिन 15 लीटर तक बचाएं!",
      reportLeakTitle: "रिसाव की रिपोर्ट करें",
      describeLeak: "रिसाव का वर्णन करें",
      addPhoto: "फोटो जोड़ें",
      addVideo: "वीडियो जोड़ें",
      voiceInput: "आवाज इनपुट",
      location: "स्थान",
      anonymousReport: "अनाम रूप से रिपोर्ट करें",
      submitReport: "रिपोर्ट सबमिट करें",
      severity: "गंभीरता: मामूली",
      offlineWarning: "ऑफ़लाइन? ऑनलाइन होने पर सिंक होगा।",
      verifyLeakTitle: "रिसाव सत्यापित करें",
      reported: "रिपोर्ट किया गया",
      description: "विवरण",
      distance: "दूरी",
      status: "स्थिति",
      photoPreview: "फोटो पूर्वावलोकन",
      verificationProgress: "सत्यापन प्रगति",
      confirmLeak: "रिसाव की पुष्टि करें",
      markFalse: "गलत के रूप में चिह्नित करें",
      comments: "अतिरिक्त टिप्पणियाँ",
      officialVerified: "आधिकारिक सत्यापित",
      leaderboardTitle: "लीडरबोर्ड और पुरस्कार",
      topReporters: "शीर्ष रिपोर्टर",
      badges: "बैज",
      aquaHero: "एक्वा हीरो",
      firstReport: "पहली रिपोर्ट",
      treeSapling: "पौधा",
      waterKit: "पानी किट",
      redeemNow: "अब रिडीम करें",
      shareAchievement: "उपलब्धि साझा करें",
      riskMapTitle: "जोखिम नक्शा",
      statsOverview: "सांख्यिकी अवलोकन",
      highRiskZones: "उच्च जोखिम क्षेत्र",
      nextLikely: "अगला संभावित (स्थान)",
      recentAlerts: "हाल के अलर्ट",
      additionalFilters: "अतिरिक्त फ़िल्टर",
      verified: "सत्यापित",
      unverified: "असत्यापित",
      downloadReport: "रिपोर्ट डाउनलोड करें",
      profileTitle: "उपयोगकर्ता प्रोफाइल",
      yourImpact: "आपका प्रभाव",
      waterSaved: "पानी बचाया",
      pointsEarned: "पॉइंट्स अर्जित",
      editProfile: "प्रोफाइल संपादित करें",
      aboutMe: "मेरे बारे में",
      preferencesStats: "प्राथमिकताएँ और आँकड़े",
      preferredLanguage: "पसंदीदा भाषा",
      favoriteTip: "पसंदीदा सुझाव",
      logout: "लॉगआउट",
      home: "होम",
      reports: "रिपोर्ट्स",
      contact: "संपर्क",
      contactSupport: "सहायता से संपर्क करें",
      followUs: "हमें फॉलो करें",
      sendMessage: "हमें संदेश भेजें",
      yourName: "आपका नाम",
      yourEmail: "आपका ईमेल",
      yourMessage: "आपका संदेश",
      submit: "जमा करें",
      settings: "सेटिंग्स",
      accountSettings: "खाता सेटिंग्स",
      emailNotifications: "ईमेल सूचनाएं",
      pushNotifications: "पुश सूचनाएं",
      appPreferences: "ऐप प्राथमिकताएं",
      language: "भाषा",
      theme: "थीम",
      dataUsage: "डेटा उपयोग",
      lowBandwidthMode: "कम बैंडविड्थ मोड",
      save: "सहेजें",
      back: "वापस",
      locationAccessDenied: "स्थान पहुंच अस्वीकृत।",
      voiceInputError: "आवाज इनपुट विफल।",
      voiceInputNotSupported: "इस ब्राउज़र में आवाज इनपुट समर्थित नहीं है।",
      imageUploaded: "छवि सफलतापूर्वक अपलोड की गई!",
      imageCompressionError: "छवि संपीड़न विफल।",
      reportSubmitted: "रिपोर्ट सबमिट की गई!",
      leakConfirmed: "रिसाव की पुष्टि की गई!",
      leakMarkedFalse: "रिसाव को गलत चिह्नित किया गया!",
      nearbyLeak: "नजदीकी रिसाव का पता चला!",
      leakNearbyBody: "100 मीटर दूर Lat: {lat}, Lon: {lng} पर रिसाव की सूचना मिली। अब सत्यापित करें!",
      messageSent: "संदेश सफलतापूर्वक भेजा गया!",
      settingsSaved: "सेटिंग्स सफलतापूर्वक सहेजी गईं!",
      profileSaved: "प्रोफाइल सफलतापूर्वक अपडेट की गई!"
    }
  };
  
  // Initialize i18next
  i18next.init({
    lng: 'en',
    resources: {
      en: { translation: translations.en },
      hi: { translation: translations.hi }
    }
  }, (err) => {
    if (err) {
      console.error('i18next initialization failed:', err);
      return;
    }
    updateContent();
    updateProfileDisplay();
  });
  
  // Update UI with translations
  function updateContent() {
    try {
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (key.startsWith('[placeholder]')) {
          element.placeholder = i18next.t(key.replace('[placeholder]', '')) || element.placeholder;
        } else {
          element.innerHTML = i18next.t(key) || element.innerHTML;
        }
      });
  
      // Sync language selectors
      const currentLang = i18next.language || 'en';
      document.getElementById('language').value = currentLang;
      document.getElementById('settings-language').value = currentLang;
      document.getElementById('report-language').value = currentLang;
  
      // Sync theme selector
      const currentTheme = document.body.getAttribute('data-theme') || 'light';
      document.getElementById('settings-theme').value = currentTheme;
      document.getElementById('theme-toggle').textContent = currentTheme === 'light' ? '🌙' : '☀️';
    } catch (error) {
      console.error('Error updating content:', error);
    }
  }
  
  // Theme Toggle
  function toggleTheme() {
    try {
      const currentTheme = document.body.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      document.getElementById('theme-toggle').textContent = newTheme === 'light' ? '🌙' : '☀️';
      document.getElementById('settings-theme').value = newTheme;
      updateContent();
    } catch (error) {
      console.error('Error toggling theme:', error);
    }
  }
  
  // Apply saved theme
  function applySavedTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    document.getElementById('theme-toggle').textContent = savedTheme === 'light' ? '🌙' : '☀️';
    document.getElementById('settings-theme').value = savedTheme;
  }
  
  // Language Change
  function changeLanguage(lang) {
    try {
      i18next.changeLanguage(lang, (err) => {
        if (err) {
          console.error('Language change failed:', err);
          return;
        }
        updateContent();
      });
    } catch (error) {
      console.error('Error changing language:', error);
    }
  }
  
  // Event Listeners for Language and Theme
  document.getElementById('language').addEventListener('change', (e) => {
    changeLanguage(e.target.value);
  });
  
  document.getElementById('settings-language').addEventListener('change', (e) => {
    changeLanguage(e.target.value);
  });
  
  document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
  
  document.getElementById('settings-theme').addEventListener('change', (e) => {
    const newTheme = e.target.value;
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    document.getElementById('theme-toggle').textContent = newTheme === 'light' ? '🌙' : '☀️';
    updateContent();
  });
  
  // Bandwidth Mode
  function setBandwidthMode() {
    const lowBandwidth = document.getElementById('low-bandwidth-mode').checked;
    document.body.setAttribute('data-bandwidth', lowBandwidth ? 'low' : 'normal');
    localStorage.setItem('bandwidth', lowBandwidth ? 'low' : 'normal');
  }
  
  // Apply saved bandwidth mode
  const savedBandwidth = localStorage.getItem('bandwidth') || 'normal';
  document.body.setAttribute('data-bandwidth', savedBandwidth);
  document.getElementById('low-bandwidth-mode').checked = savedBandwidth === 'low';
  
  // Screen Navigation
  function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(screen => {
      screen.classList.remove('active');
    });
    document.getElementById(screenId).classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  
  // Initialize Maps
  let homeMap, verifyMap, riskMap;
  function initMaps() {
    try {
      homeMap = L.map('map').setView([51.505, -0.09], 13);
      verifyMap = L.map('verify-map').setView([51.505, -0.09], 13);
      riskMap = L.map('risk-map-container').setView([51.505, -0.09], 13);
  
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(homeMap);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(verifyMap);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(riskMap);
  
      L.marker([51.5, -0.09]).addTo(homeMap).bindPopup('Sample Leak Location').openPopup();
      L.marker([51.5, -0.09]).addTo(verifyMap).bindPopup('Leak to Verify').openPopup();
      L.marker([51.5, -0.09]).addTo(riskMap).bindPopup('High Risk Zone').openPopup();
    } catch (error) {
      console.error('Error initializing maps:', error);
    }
  }
  
  // Get User Location
  function getUserLocation(callback) {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          callback({ lat: latitude, lng: longitude });
        },
        () => {
          alert(i18next.t('locationAccessDenied'));
          callback(null);
        }
      );
    } else {
      alert(i18next.t('locationAccessDenied'));
      callback(null);
    }
  }
  
  // Report Form Submission
  document.getElementById('report-form').addEventListener('submit', (e) => {
    e.preventDefault();
    getUserLocation((coords) => {
      if (coords) {
        document.getElementById('location').value = `Lat: ${coords.lat}, Lon: ${coords.lng}`;
        alert(i18next.t('reportSubmitted'));
        showScreen('home');
      }
    });
  });
  
  // Image Upload with Compression
  document.getElementById('photo-upload').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      new Compressor(file, {
        quality: 0.6,
        success(compressedResult) {
          alert(i18next.t('imageUploaded'));
        },
        error() {
          alert(i18next.t('imageCompressionError'));
        }
      });
    }
  });
  
  // Voice Input
  function startVoiceInput() {
    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = document.getElementById('report-language').value;
      recognition.start();
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById('leak-desc').value = transcript;
      };
      recognition.onerror = () => {
        alert(i18next.t('voiceInputError'));
      };
    } else {
      alert(i18next.t('voiceInputNotSupported'));
    }
  }
  
  // Verify Leak
  function verifyLeak(isConfirmed) {
    document.getElementById('leak-status').textContent = isConfirmed ? 'Confirmed' : 'False';
    alert(i18next.t(isConfirmed ? 'leakConfirmed' : 'leakMarkedFalse'));
  }
  
  // Share Achievement
  function shareAchievement() {
    if (navigator.share) {
      navigator.share({
        title: i18next.t('aquaHero'),
        text: i18next.t('shareAchievement'),
        url: window.location.href
      });
    } else {
      alert('Sharing not supported on this device.');
    }
  }
  
  // Profile Management
  let userProfile = {
    name: 'Aqua User',
    email: 'aquauser@example.com',
    bio: 'I’m passionate about water conservation and helping my community reduce water waste!',
    location: 'Not Set',
    waterSaved: '500L',
    points: '150',
    reports: '5',
    verifications: '3',
    joined: 'January 2025',
    language: 'English',
    favoriteTip: 'Fix dripping faucets to save up to 15L per day!',
    emailNotifications: 'Enabled',
    pushNotifications: 'Enabled'
  };
  
  function updateProfileDisplay() {
    try {
      document.getElementById('user-name').textContent = userProfile.name;
      document.getElementById('user-email').textContent = userProfile.email;
      document.getElementById('user-location').textContent = `Location: ${userProfile.location}`;
      document.getElementById('user-bio').textContent = userProfile.bio;
      document.getElementById('user-water-saved').textContent = userProfile.waterSaved;
      document.getElementById('user-points').textContent = userProfile.points;
      document.getElementById('user-reports').textContent = userProfile.reports;
      document.getElementById('user-verifications').textContent = userProfile.verifications;
      document.getElementById('user-joined').textContent = userProfile.joined;
      document.getElementById('user-language').textContent = userProfile.language;
      document.getElementById('user-favorite-tip').textContent = userProfile.favoriteTip;
      document.getElementById('user-email-notifications').textContent = userProfile.emailNotifications;
      document.getElementById('user-push-notifications').textContent = userProfile.pushNotifications;
    } catch (error) {
      console.error('Error updating profile display:', error);
    }
  }
  
  function toggleEditProfile() {
    const profileDetails = document.querySelector('.profile-details');
    profileDetails.classList.toggle('editing');
    if (profileDetails.classList.contains('editing')) {
      document.getElementById('edit-user-name').value = userProfile.name;
      document.getElementById('edit-bio').value = userProfile.bio;
    }
  }
  
  function saveProfile() {
    userProfile.name = document.getElementById('edit-user-name').value;
    userProfile.bio = document.getElementById('edit-bio').value;
    updateProfileDisplay();
    toggleEditProfile();
    alert(i18next.t('profileSaved'));
  }
  
  // Contact Form Submission
  function submitContactForm() {
    const name = document.getElementById('contact-name').value;
    const email = document.getElementById('contact-email').value;
    const message = document.getElementById('contact-message').value;
    if (name && email && message) {
      alert(i18next.t('messageSent'));
      showScreen('home');
    } else {
      alert('Please fill out all fields.');
    }
  }
  
  // Save Settings
  function saveSettings() {
    try {
      userProfile.language = document.getElementById('settings-language').value;
      changeLanguage(userProfile.language);
      const theme = document.getElementById('settings-theme').value;
      document.body.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      document.getElementById('theme-toggle').textContent = theme === 'light' ? '🌙' : '☀️';
      userProfile.emailNotifications = document.getElementById('email-notifications').checked ? 'Enabled' : 'Disabled';
      userProfile.pushNotifications = document.getElementById('push-notifications').checked ? 'Enabled' : 'Disabled';
      setBandwidthMode();
      updateProfileDisplay();
      alert(i18next.t('settingsSaved'));
    } catch (error) {
      console.error('Error saving settings:', error);
    }
  }
  
  // Logout
  function logout() {
    alert('Logged out successfully!');
    showScreen('home');
  }
  
  // Initialize on Load
  document.addEventListener('DOMContentLoaded', () => {
    try {
      applySavedTheme();
      initMaps();
      updateContent();
      showScreen('home');
  
      // Check for nearby leaks
      getUserLocation((coords) => {
        if (coords) {
          const message = i18next.t('leakNearbyBody', { lat: coords.lat, lng: coords.lng });
          if (Notification.permission === 'granted') {
            new Notification(i18next.t('nearbyLeak'), { body: message });
          } else if (Notification.permission !== 'denied') {
            Notification.requestPermission().then(permission => {
              if (permission === 'granted') {
                new Notification(i18next.t('nearbyLeak'), { body: message });
              }
            });
          }
        }
      });
    } catch (error) {
      console.error('Error during initialization:', error);
    }
  });
  
  // Service Worker Registration
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').catch(error => {
        console.error('Service Worker registration failed:', error);
      });
    });
  }